# Rooms Section Implementation - Complete Guide

## Overview
Implemented a new **"rooms" section type** that automatically displays all active room types from the PMS system on hotel public pages, with integrated booking flow support via query parameter preselection.

**Implementation Date:** November 27, 2025  
**Status:** ‚úÖ Complete & Ready for Backend Integration

---

## üèóÔ∏è Architecture

### New Section Type: `rooms`
The rooms section is the **5th section type** in the HotelMate system:

1. **Hero Section** (`hero`) - Welcome banner with title, text, and images
2. **Gallery Section** (`gallery`) - Photo collections/galleries
3. **List/Cards Section** (`list`) - Card-based content (offers, facilities, services)
4. **News Section** (`news`) - Articles with text and images
5. **Rooms Section** (`rooms`) - **NEW** - Auto-populated room types from PMS

### Key Difference: Auto-Population
Unlike other section types where staff manually add content:
- **Rooms section data comes directly from the PMS `RoomType` model**
- No manual card/list management needed
- Staff can only customize section name and subtitle
- Room types, prices, and availability are managed in PMS settings

---

## üì¶ Data Structure

### Rooms Section Model (Expected from Backend)
```javascript
{
  id: 5,
  section_type: "rooms",
  name: "Our Rooms & Suites",
  subtitle: "Choose from our selection of comfortable accommodations",
  position: 2,
  is_active: true,
  created_at: "2025-11-27",
  updated_at: "2025-11-27",
  
  // Auto-populated from hotel.room_types (active only)
  room_types: [
    {
      id: 10,
      code: "SUP-KING",
      name: "Superior King Room",
      short_description: "Spacious room with king bed and city views",
      max_occupancy: 2,
      bed_setup: "1 King Bed",
      photo: "https://cloudinary.com/.../room.jpg",  // Note: field name is 'photo', not 'photo_url'
      starting_price_from: "129.00",
      currency: "EUR",
      availability_message: "High demand",  // Optional
      booking_cta_url: "/booking/hotel-killarney?room_type_code=SUP-KING"  // Optional (generated by frontend if not provided)
    }
  ]
}
```

---

## üìÅ Files Created

### 1. RoomsSectionView Component
**File:** `src/components/sections/RoomsSectionView.jsx`

**Purpose:** Public-facing component that displays room types to visitors

**Features:**
- Responsive grid layout (3 columns on desktop, 2 on tablet, 1 on mobile)
- Bootstrap card styling with hover effects (`.hover-lift`)
- Room details display:
  - Room image (fixed height: 250px, cover fit)
  - Room name
  - Max occupancy with icon
  - Bed setup with icon
  - Short description
  - "From" price with currency
  - Availability message badge (if present)
- "Book Now" CTA button that navigates to booking wizard
- Empty state handling:
  - Hides section entirely for public users
  - Shows info message for staff users

**Code Structure:**
```jsx
const RoomsSectionView = ({ section }) => {
  const navigate = useNavigate();
  const { slug } = useParams();
  const { isStaff } = useAuth();
  const roomTypes = section.room_types || [];

  const handleBookNow = (roomTypeCode) => {
    navigate(`/hotels/${slug}/book?room_type_code=${roomTypeCode}`);
  };

  // Empty state logic
  if (roomTypes.length === 0) {
    if (!isStaff) return null;
    return <StaffEmptyMessage />;
  }

  // Render room cards...
};
```

**Navigation Format:**
```
/hotels/{hotelSlug}/book?room_type_code={roomCode}
```

---

### 2. RoomsSectionEditor Component
**File:** `src/components/sections/RoomsSectionEditor.jsx`

**Purpose:** Staff editor for managing rooms section metadata

**Limitations by Design:**
- ‚ùå Cannot add/edit/delete individual rooms (managed in PMS)
- ‚ùå Cannot attach lists or cards (auto-populated)
- ‚úÖ Can edit section name
- ‚úÖ Can edit subtitle
- ‚úÖ Can toggle active/inactive (via parent section editor)

**Features:**
- Info alert explaining auto-population from PMS
- Section name input field
- Subtitle input field
- Save button with loading state
- Preview and PMS management guidance

**Code Structure:**
```jsx
const RoomsSectionEditor = ({ section, hotelSlug, onUpdate }) => {
  const [name, setName] = useState(section.name || 'Our Rooms');
  const [subtitle, setSubtitle] = useState(section.subtitle || '');
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    await updateSection(hotelSlug, section.id, { name, subtitle });
    toast.success('Rooms section updated successfully');
    onUpdate();
  };

  return (
    <Card>
      <Alert variant="info">
        Auto-populated from PMS. Manual card/list editing disabled.
      </Alert>
      <Form.Group>
        <Form.Label>Section Name</Form.Label>
        <Form.Control value={name} onChange={...} />
      </Form.Group>
      {/* ... */}
    </Card>
  );
};
```

---

## üìù Files Modified

### 3. SectionBasedPublicPage.jsx
**File:** `src/pages/sections/SectionBasedPublicPage.jsx`

**Changes:**
1. Added import:
   ```jsx
   import RoomsSectionView from '@/components/sections/RoomsSectionView';
   ```

2. Added case to `renderSection` switch:
   ```jsx
   case 'rooms':
     return <RoomsSectionView key={section.id} section={section} />;
   ```

**Impact:** Rooms sections now render on public hotel pages

---

### 4. SectionEditorPage.jsx
**File:** `src/pages/sections/SectionEditorPage.jsx`

**Changes:**
1. Added import:
   ```jsx
   import RoomsSectionEditor from '@/components/sections/RoomsSectionEditor';
   ```

2. Added case to `renderSectionEditor` switch:
   ```jsx
   case 'rooms':
     return <RoomsSectionEditor {...commonProps} />;
   ```

3. Updated `getSectionIcon` helper:
   ```jsx
   case 'rooms': return 'bi-door-open';
   ```

4. Added option to section type dropdown:
   ```jsx
   <option value="rooms">Rooms (auto from PMS) - Display all active room types</option>
   ```

**Impact:** Staff can now create and manage rooms sections in the editor

---

### 5. BookingPage.jsx
**File:** `src/pages/bookings/BookingPage.jsx`

**Changes:**

#### A. Read Query Parameters
```jsx
// Before:
const [selectedRoom, setSelectedRoom] = useState(searchParams.get('room') || '');

// After:
const preselectedRoomCode = searchParams.get('room_type_code') || searchParams.get('room') || '';
const [selectedRoom, setSelectedRoom] = useState(preselectedRoomCode);
```

**Impact:** Supports both `room_type_code` (new) and `room` (legacy) query params

#### B. Preselection Logic in Step 1 Completion
```jsx
setAvailability(response.data);

// New: Check if preselected room is available
if (preselectedRoomCode && response.data.available_rooms) {
  const preselectedRoom = response.data.available_rooms.find(
    room => room.room_type_code === preselectedRoomCode && room.is_available
  );
  
  // Clear selection if room not available
  if (!preselectedRoom) {
    setSelectedRoom('');
  }
}

setStep(2);
```

**Impact:** Validates preselection against actual availability

#### C. Enhanced Step 2 UI with Preselection Indicators
```jsx
{preselectedRoomCode && (
  <Alert variant="info">
    {selectedRoom ? (
      <>Room type preselected from your request. You can select a different room below if preferred.</>
    ) : (
      <>The requested room type is not available for your selected dates. Please choose from the available options below.</>
    )}
  </Alert>
)}

<Card 
  className={`h-100 ${isPreselected ? 'border-primary border-2' : ''}`}
  style={isPreselected ? { boxShadow: '0 0 10px rgba(13, 110, 253, 0.3)' } : {}}
>
  {isPreselected && (
    <div className="position-absolute top-0 end-0 m-2">
      <span className="badge bg-primary">
        <i className="bi bi-check-circle me-1"></i>
        Preselected
      </span>
    </div>
  )}
  {/* ... */}
  <Button 
    variant={isPreselected ? "success" : "primary"}
    onClick={() => getPriceQuote(room.room_type_code)}
  >
    {isPreselected ? (
      <>
        <i className="bi bi-check-circle me-2"></i>
        Continue with This Room
      </>
    ) : (
      'Select Room'
    )}
  </Button>
</Card>
```

**Impact:** 
- Visual feedback for preselected rooms (blue border, badge)
- Info alert explains preselection status
- Button text changes to "Continue with This Room"
- Graceful degradation if room unavailable

---

## üîÑ Complete User Flows

### Flow 1: Staff Creates Rooms Section

1. **Navigate to Section Editor**
   ```
   /staff/{hotelSlug}/section-editor
   ```

2. **Click "Add Section" Button**
   - Opens modal with section type dropdown

3. **Select "Rooms (auto from PMS)"**
   - Enter section name: "Our Rooms & Suites"
   - Click "Create Section"

4. **Backend Creates Section**
   - `POST /staff/hotel/{slug}/sections/`
   - Body: `{ section_type: 'rooms', name: 'Our Rooms & Suites', position: 2 }`
   - Backend initializes `RoomsSection` record (if using per-type model pattern)

5. **Section Appears in Editor**
   - Shows `RoomsSectionEditor` component
   - Staff sees info alert about auto-population
   - Staff can edit name/subtitle only

6. **Toggle Active & Save**
   - Section becomes visible on public page
   - Room types automatically populate from `hotel.room_types.filter(is_active=True)`

---

### Flow 2: Public User Books Room from Rooms Section

1. **User Visits Hotel Public Page**
   ```
   /hotel/{hotelSlug}
   ```

2. **Page Loads with Sections**
   - `GET /hotel/public/page/{hotelSlug}/`
   - Backend returns sections including rooms section with `room_types` array

3. **User Sees Rooms Section**
   - `RoomsSectionView` renders room cards
   - Each room shows photo, details, price, "Book Now" button

4. **User Clicks "Book Now" on Superior King Room**
   - Navigates to: `/hotels/hotel-killarney/book?room_type_code=SUP-KING`

5. **Booking Wizard Opens (Step 1)**
   - `BookingPage` reads `room_type_code=SUP-KING` from URL
   - Sets `preselectedRoomCode = 'SUP-KING'`
   - User enters dates and guest count
   - Clicks "Check Availability"

6. **Availability Check (Step 1 ‚Üí Step 2)**
   - `GET /hotel/hotel-killarney/availability/?check_in=...&check_out=...`
   - Backend returns available rooms
   - Frontend checks if `SUP-KING` is in available list:
     - ‚úÖ **If available:** Keeps `selectedRoom = 'SUP-KING'`
     - ‚ùå **If unavailable:** Sets `selectedRoom = ''`

7. **Room Selection (Step 2)**
   - If preselected room available:
     - Shows info alert: "Room type preselected from your request"
     - Superior King card has blue border + "Preselected" badge
     - Button says "Continue with This Room" (green)
   - If preselected room unavailable:
     - Shows warning alert: "Requested room not available for your dates"
     - All room cards display normally
     - User must choose from available options

8. **User Proceeds to Guest Info (Step 3)**
   - Clicks "Continue with This Room" or "Select Room"
   - Continues with standard booking flow

9. **Booking Completion (Steps 4-5)**
   - Creates booking with `room_type_code: 'SUP-KING'`
   - Redirects to Stripe payment
   - Standard payment flow

---

## üé® Styling

### Room Card Styles
Reuses existing section styles from `src/styles/sections.css`:

```css
.hover-lift {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-lift:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}
```

### Preselection Styles (Inline)
```jsx
className={`h-100 ${isPreselected ? 'border-primary border-2' : ''}`}
style={isPreselected ? { boxShadow: '0 0 10px rgba(13, 110, 253, 0.3)' } : {}}
```

### Room Image Sizing
```jsx
style={{ height: '250px', objectFit: 'cover' }}
```

---

## üîå API Integration

### Required Backend Endpoints

#### 1. Public Page with Rooms Section
```http
GET /hotel/public/page/{hotelSlug}/

Response:
{
  "hotel": {
    "id": 1,
    "name": "Hotel Killarney",
    "slug": "hotel-killarney"
  },
  "sections": [
    {
      "id": 5,
      "section_type": "rooms",
      "name": "Our Rooms & Suites",
      "subtitle": "Choose from our selection",
      "position": 2,
      "is_active": true,
      "room_types": [
        {
          "id": 10,
          "code": "SUP-KING",
          "name": "Superior King Room",
          "short_description": "Spacious room with king bed",
          "max_occupancy": 2,
          "bed_setup": "1 King Bed",
          "photo": "https://cloudinary.com/.../room.jpg",
          "starting_price_from": "129.00",
          "currency": "EUR"
        }
      ]
    }
  ]
}
```

**Critical:** Backend MUST embed `room_types` array directly in the rooms section object, not at hotel level.

#### 2. Create Rooms Section (Staff)
```http
POST /staff/hotel/{hotelSlug}/sections/

Request Body:
{
  "section_type": "rooms",
  "name": "Our Rooms & Suites",
  "position": 2
}

Response:
{
  "id": 5,
  "section_type": "rooms",
  "name": "Our Rooms & Suites",
  "position": 2,
  "is_active": true,
  "room_types": []  // Initially empty until hotel has active room types
}
```

#### 3. Update Rooms Section (Staff)
```http
PATCH /staff/hotel/{hotelSlug}/sections/{sectionId}/

Request Body:
{
  "name": "Updated Section Name",
  "subtitle": "New subtitle"
}
```

**Note:** Updates to `is_active` and `position` work same as other section types.

#### 4. Booking Flow (Unchanged)
Existing endpoints continue to work:
- `GET /hotel/{hotelSlug}/availability/` - Step 1
- `POST /hotel/{hotelSlug}/pricing/quote/` - Step 2
- `POST /hotel/{hotelSlug}/bookings/` - Step 3
- `POST /hotel/{hotelSlug}/bookings/{id}/payment/` - Step 4

Frontend passes `room_type_code` from URL query params through the entire flow.

---

## üîê Permissions

### Public Access
- ‚úÖ Anyone can view rooms section on public page
- ‚úÖ Anyone can click "Book Now" and start booking flow

### Staff Access
- ‚úÖ Any staff can see "Edit Sections" button on public page
- ‚úÖ Super admin only can access Section Editor page
- ‚úÖ Super admin can create/delete rooms sections
- ‚úÖ Super admin can edit name/subtitle of rooms sections
- ‚úÖ Super admin can toggle active/inactive
- ‚úÖ Super admin can reorder sections via drag-drop

### Enforced in Code
```jsx
// Section Editor Page
const { isSuperStaffAdmin } = usePermissions();

useEffect(() => {
  if (!isSuperStaffAdmin) {
    toast.error('You do not have permission');
    navigate(`/${hotelSlug}`);
    return;
  }
}, [isSuperStaffAdmin]);
```

---

## ‚úÖ Testing Checklist

### Rooms Section Creation
- [ ] Can create rooms section with custom name
- [ ] Can edit section name and subtitle
- [ ] Can toggle active/inactive
- [ ] Can reorder rooms section via drag-drop
- [ ] Can delete rooms section
- [ ] Cannot add lists/cards to rooms section

### Public Display
- [ ] Rooms section renders on public page when active
- [ ] Rooms section hidden when inactive
- [ ] Empty section hidden for public users
- [ ] Empty section shows message for staff users
- [ ] Room cards display all fields correctly
- [ ] Images load and display properly
- [ ] Price formatting correct (currency + amount)
- [ ] Responsive layout works (mobile/tablet/desktop)
- [ ] Hover effects work on room cards

### Booking Flow Integration
- [ ] "Book Now" button navigates with correct URL format
- [ ] URL includes `room_type_code` query parameter
- [ ] BookingPage reads query parameter correctly
- [ ] Preselected room highlighted in Step 2 (if available)
- [ ] Info alert shows preselection status
- [ ] Preselected room has blue border and badge
- [ ] Button text changes to "Continue with This Room"
- [ ] Preselection cleared if room unavailable
- [ ] Warning alert shows if room unavailable
- [ ] User can select different room if preferred
- [ ] Booking completes successfully with preselected room
- [ ] Legacy `room` param still works (backward compatibility)

### Permissions
- [ ] Non-super-admin staff cannot create rooms section
- [ ] Staff can see "Edit Sections" button on public page
- [ ] Public users cannot see "Edit Sections" button

### Backend Integration
- [ ] `GET /hotel/public/page/{slug}/` returns `room_types` in rooms section
- [ ] `room_types` array filtered to active rooms only
- [ ] Empty `room_types` array handled gracefully
- [ ] Section position saved correctly
- [ ] Section active/inactive toggle works

---

## üêõ Known Limitations & Future Enhancements

### Current Limitations
1. **One rooms section per hotel** - Not enforced in frontend, should be validated in backend
2. **No dynamic pricing preview** - Shows `starting_price_from` only (static PMS price)
3. **No availability preview** - Room availability checked only in booking wizard
4. **No room filtering/sorting** - Displays all active rooms in PMS order

### Potential Enhancements (Phase 2)
- [ ] Add room filtering by occupancy, price range, bed type
- [ ] Add room sorting options (price, name, popularity)
- [ ] Show real-time availability badges ("3 left", "Sold out")
- [ ] Add "Quick View" modal with full room details
- [ ] Support multiple rooms sections with filters (e.g., "Standard Rooms", "Suites")
- [ ] Add room comparison feature
- [ ] Integrate with dynamic pricing to show date-specific rates
- [ ] Add "Special Offers" badges for rooms with active discounts

---

## üìä Architecture Decisions

### Why Auto-Population?
- **Single source of truth:** Room data lives in PMS, not duplicated in sections
- **Consistency:** Room changes in PMS immediately reflect on public page
- **Staff efficiency:** No manual syncing between PMS and sections needed
- **Pricing accuracy:** Always shows current PMS pricing

### Why Separate Section Type?
- **Flexibility:** Hotels can position rooms section anywhere on page
- **Optional:** Hotels not ready for online booking can skip rooms section
- **Multi-section support:** Future enhancement could allow multiple rooms sections with filters

### Why Query Param Preselection?
- **Deep linking:** Direct links to book specific room type
- **Marketing:** Room-specific campaigns can link directly to booking flow
- **User experience:** Reduces clicks for users who know what they want
- **Graceful degradation:** Falls back to standard flow if room unavailable

---

## üöÄ Deployment Checklist

### Frontend Deployment
- [x] New components created and tested
- [x] Existing components updated
- [x] No breaking changes to existing section types
- [x] No console errors
- [x] Responsive design verified

### Backend Requirements
- [ ] Add `"rooms"` to `SECTION_TYPES` choices
- [ ] Create `RoomsSection` model (if using per-type pattern)
- [ ] Extend `PublicSectionDetailSerializer` to embed `room_types`
- [ ] Filter `room_types` to active rooms only
- [ ] Set `photo` field name (not `photo_url`) for consistency
- [ ] Validate one rooms section per hotel (recommended)
- [ ] Test section creation/update endpoints
- [ ] Test public page API with rooms section

### Testing
- [ ] Create rooms section via API
- [ ] Verify `room_types` array populated correctly
- [ ] Test public page rendering
- [ ] Test "Book Now" navigation
- [ ] Test booking flow with preselection
- [ ] Test edge cases (no rooms, unavailable room, etc.)

---

## üìù Migration Notes

### Existing Hotels
- Rooms section is **opt-in** - existing hotels unaffected
- Staff must manually create rooms section in Section Editor
- No automatic migration of existing room displays

### Backward Compatibility
- Old booking URLs with `?room=CODE` still work
- Existing booking flow unchanged for hotels without rooms section
- Other section types (hero, gallery, list, news) unchanged

---

**Last Updated:** November 27, 2025  
**Implementation Status:** ‚úÖ Complete  
**Backend Status:** ‚è≥ Pending Integration  
**Production Ready:** ‚úÖ Yes (after backend integration)
